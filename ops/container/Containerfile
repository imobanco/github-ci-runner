FROM ubuntu:jammy

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
  && apt-get install -y --no-install-recommends \
    liblttng-ust1 \
    libkrb5-3 \
    zlib1g \
    libssl3 \
    libicu70 \
    curl \
    jq \
    ca-certificates \
    sudo \
    xz-utils


ARG GH_RUNNER_VERSION="2.301.1"
ARG TARGET_PLATFORM="x64"


WORKDIR /home/runner_user

RUN addgroup runner_group \
 && adduser \
    --quiet \
    --disabled-password \
    --shell /bin/bash \
    --home /home/runner_user \
    --gecos "User" runner_user \
    --ingroup runner_group \
 && chmod 0700 /home/runner_user \
 && chown --recursive runner_user:runner_group /home/runner_user \
 && echo '%sudo ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers

# USER runner_user


RUN mkdir /home/runner_user/_work && mkdir /home/runner_user/runner-cli

COPY ./ops/bash/install_runner.sh /home/runner_user

RUN ls -la /home/runner_user/

RUN chmod +x /home/runner_user/install_runner.sh

RUN /home/runner_user/install_runner.sh ${GH_RUNNER_VERSION} ${TARGET_PLATFORM} \
  && rm /home/runner_user/install_runner.sh

COPY ./ops/bash/runner_token.sh ./ops/bash/entrypoint.sh /home/runner_user
RUN chmod +x /home/runner_user/runner_token.sh /home/runner_user/entrypoint.sh


ENTRYPOINT ["./entrypoint.sh"]
CMD ["./runner-cli/bin/Runner.Listener", "run", "--startuptype", "service"]
