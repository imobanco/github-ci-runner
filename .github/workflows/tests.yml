name: tests


on: workflow_dispatch



jobs:
  test:
    runs-on:
      # group: nixgroup
      labels: nixos
    name: NixOS Testes
    steps:
      - name: checkout PR merge commit
        uses: actions/checkout@v4
        with:
          # Nix Flakes doesn't work on shallow clones
          fetch-depth: 0

      - name: Recolhe info
        run: |
          id
          pwd
          ls -la /nix/store | grep hello
          echo "${PATH//:/$'\n'}"

      - name: Recolhe info show-config
        run: |
          nix show-config

      - name: Testa ping
        run: |
          python --version
          stat -c '%a %n' $(which ping)
          stat -c '%a %n' $(readlink -f $(which ping))
          # /run/current-system/sw/bin/ping -c3 8.8.8.8 # Funciona tb, mas comentado para poupar um pouco de tempo.
          ping -c3 8.8.8.8

      - name: profile install hello test
        run: |
          nix profile install nixpkgs#hello
          echo "${PATH//:/$'\n'}"
          nix profile list
          # ls -alh "$HOME"/.nix-profile
          # ls -alh "$HOME"/.nix-profile/
          ls -alh /nix/var/nix/profiles/per-user/nixuser/profile
          ls -alh /nix/var/nix/profiles/per-user/nixuser/profile/bin
          hello

      - name: profile install node test
        run: |
          nix profile install nixpkgs#nodejs
          echo "${PATH//:/$'\n'}"
          nix profile list
          # /home/nixuser/.nix-profile/bin/node --version
          node --version

      - name: Testa sudo
        run: |
          stat -c '%a %n' $(which sudo)
          stat -c '%a %n' $(readlink -f $(which sudo))
          stat -c '%a %n' /run/wrappers/bin/sudo
          stat -c '%a %n' /run/current-system/sw/bin/sudo
          echo 12345
          sudo id
          /run/wrappers/bin/sudo id
          /run/current-system/sw/bin/sudo id
